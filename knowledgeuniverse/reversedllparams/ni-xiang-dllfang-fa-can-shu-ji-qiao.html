<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DLL方法参数逆向技巧 | AngryQi</title>
  
  <meta name="description" content="# 背景 对接海康SDK使用透传协议连接交换机时，发现每次透传调用都不成功，而SDK自带的DEMO却能够成功，反复确认文档发现自己调用的方式并没有什么错误的地方，但通过 wireshark 抓包却发现调用sdk透传的是空字符串，而 sdk 却有消息体，所以决定逆向 demo 程序 ">
    <meta name="keywords" content="逆向 DLL 动态链接库 方法 CheatEngine">
  <link rel="preload" href="https://pldq.gitee.io/assets/css/0.styles.b1164d51.css" as="style"><link rel="preload" href="https://pldq.gitee.io/assets/js/app.2411ec71.js" as="script"><link rel="preload" href="https://pldq.gitee.io/assets/js/3.851c330d.js" as="script"><link rel="preload" href="https://pldq.gitee.io/assets/js/7.b83aea1c.js" as="script"><link rel="preload" href="https://pldq.gitee.io/assets/js/5.7cb4259c.js" as="script"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/10.bef563c9.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/11.743d948a.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/12.f4c3dc72.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/13.91441604.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/14.f40b6248.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/15.623ac902.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/16.5715ddd1.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/17.224f8cf6.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/4.75e08570.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/6.b74c953f.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/8.1082e4f1.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/9.d502b2d0.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/vendors~flowchart.e276d141.js">
  <link rel="stylesheet" href="https://pldq.gitee.io/assets/css/0.styles.b1164d51.css">
</head>
<body>
<div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/default-avatar.png" alt="AngryQi" class="logo"> <span class="site-name can-hide">AngryQi</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/troubleshooting/index.html" class="nav-link">
  问题处理
</a></div><div class="nav-item"><a href="/knowledgeUniverse/index.html" class="nav-link">
  知识宇宙
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/troubleshooting/index.html" class="nav-link">
  问题处理
</a></div><div class="nav-item"><a href="/knowledgeUniverse/index.html" class="nav-link">
  知识宇宙
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>DLL方法参数逆向技巧</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledgeuniverse/reversedllparams/ni-xiang-dllfang-fa-can-shu-ji-qiao.html#背景" class="sidebar-link">背景</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/knowledgeuniverse/reversedllparams/ni-xiang-dllfang-fa-can-shu-ji-qiao.html#准备工具" class="sidebar-link">准备工具</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/knowledgeuniverse/reversedllparams/ni-xiang-dllfang-fa-can-shu-ji-qiao.html#过程" class="sidebar-link">过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledgeuniverse/reversedllparams/ni-xiang-dllfang-fa-can-shu-ji-qiao.html#dissect-data-and-structure" class="sidebar-link">Dissect Data and Structure</a></li></ul></li><li><a href="/knowledgeuniverse/reversedllparams/ni-xiang-dllfang-fa-can-shu-ji-qiao.html#结果" class="sidebar-link">结果</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>对接海康SDK使用透传协议连接交换机时，发现每次透传调用都不成功，而SDK自带的DEMO却能够成功，反复确认文档发现自己调用的方式并没有什么错误的地方，但通过 wireshark 抓包却发现调用sdk透传的是空字符串，而 sdk 却有消息体，所以决定逆向 demo 程序</p> <p><img alt="" data-src="https://pldq.gitee.io/assets/img/20200717161013.32f0d566.png" loading="lazy" class="lazy"></p> <p>透传说明文档指出，透传需要三个参数，<code>lUserID</code>、<code>lpInputParam</code>、<code>lpOutputParam</code>，传入结构体类型如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token punctuation">{</span>
	DWORD    dwSize<span class="token punctuation">;</span>
	<span class="token keyword">void</span>     <span class="token operator">*</span>lpRequestUrl<span class="token punctuation">;</span>
	DWORD    dwRequestUrlLen<span class="token punctuation">;</span>
	<span class="token keyword">void</span>     <span class="token operator">*</span>lpInBuffer<span class="token punctuation">;</span>
	DWORD    dwInBufferSize<span class="token punctuation">;</span>
	DWORD    dwRecvTimeOut<span class="token punctuation">;</span>
	BYTE     byForceEncrpt<span class="token punctuation">;</span>
	BYTE     byNumOfMultiPart<span class="token punctuation">;</span>
	BYTE     byRes<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
NET_DVR_XML_CONFIG_INPUT<span class="token punctuation">,</span><span class="token operator">*</span>LPNET_DVR_XML_CONFIG_INPUT<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="准备工具"><a href="#准备工具" class="header-anchor">#</a> 准备工具</h2> <ul><li>Cheat Engine</li></ul> <h2 id="过程"><a href="#过程" class="header-anchor">#</a> 过程</h2> <ol><li>打开 Demo 程序<br> <img alt="" data-src="https://pldq.gitee.io/assets/img/20200717145211.5e2701e9.png" loading="lazy" class="lazy"></li> <li>使用 Cheat Engine 附加 demo 进程<br> <img alt="" data-src="https://pldq.gitee.io/assets/img/20200717150222.3eadd4f1.png" loading="lazy" class="lazy"></li> <li>进入 Memory View -&gt; Enumerate DLL's and Symbols，找到 sdk DLL 暴露出的透传API函数<br> <img alt="" data-src="https://pldq.gitee.io/assets/img/20200630145753.669bc596.png" loading="lazy" class="lazy"></li> <li>直接进入函数下断点，使用 DEMO 进行协议透传，程序会执行到断点，但还不够，我们需要知道函数参数的值和类型<br> <img alt="" data-src="https://pldq.gitee.io/assets/img/20200717155645.32de04fc.png" loading="lazy" class="lazy"></li> <li>学过汇编的我们都知道，函数参数入栈是从右往左进行入栈的，并且栈的内存是从高到低排列的，栈顶位于内存低位</li></ol> <div class="language-text line-numbers-mode"><pre class="language-text"><code>mov [rsp+18],r8     # 第三个参数 lpOutputParam
mov [rsp+10],rdx    # 第二个参数 lpInputParam
mov [rsp+08],ecx    # 第一个参数 lUserID
sub rsp,38          # 分配堆栈内存
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>由于我们已经知道了参数类型和作用，直接去内存区域看 <code>lpInputParam</code> 地址的对应参数值即可</p> <p><img alt="" data-src="https://pldq.gitee.io/assets/img/20200717163258.6957e21a.png" loading="lazy" class="lazy"></p> <p><img alt="" data-src="https://pldq.gitee.io/assets/img/20200717163843.32b25d3a.jpg" loading="lazy" class="lazy"></p> <h3 id="dissect-data-and-structure"><a href="#dissect-data-and-structure" class="header-anchor">#</a> Dissect Data and Structure</h3> <p>此工具会根据上下文猜测结构字段类型，并且可以检查和比较内存区域或者结构体，通过此工具可以<strong>直接查看各个字段的值</strong></p> <p><img alt="" data-src="https://pldq.gitee.io/assets/img/20200630145914.bffa94af.png" loading="lazy" class="lazy"></p> <h2 id="结果"><a href="#结果" class="header-anchor">#</a> 结果</h2> <p>通过以上逆向操作可以知道 <code>lpInBuffer</code> 传入的直接是 body 字符串，而不是 <code>NET_DVR_MIME_UNIT</code> 结构体</p> <p>这真的是 “木遇到水，我服了我服了...”</p> <p><img alt="" data-src="https://pldq.gitee.io/assets/img/20200717165539.651a583f.png" loading="lazy" class="lazy"></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新日期:</span> <span class="time">2021-2-20 18:07:01</span></div></footer> <!---->  <div class="comments-container"></div></main></div><div class="global-ui"><!----><!----></div></div>
<script src="https://pldq.gitee.io/assets/js/app.2411ec71.js" defer></script><script src="https://pldq.gitee.io/assets/js/3.851c330d.js" defer></script><script src="https://pldq.gitee.io/assets/js/7.b83aea1c.js" defer></script><script src="https://pldq.gitee.io/assets/js/5.7cb4259c.js" defer></script>
</body>
</html>
