<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Maven依赖位置引发的惨案 | AngryQi</title>
  
  <meta name="description" content="# 版本号 SpringBoot：2.1.5.RELEASE Freemarker：2.3.28 # 问题 使用浏览器查看Web页面时，页面显示以下信息： Whitelabel Error Page This application has no explicit mapping for /error, so you are seeing this as a fallback. Wed Nov 06 20:40:56 CST 2019 There was an unexpected error (type=Internal Server Error, status=500). Circular view path [xxx]: would dispatch back to the current handler URL [xxx] again. Check your ViewResolver setup! (Hint: This may be the result of an unspecified view, due to default view name generation.) ">
    <meta name="keywords" content="SpringBoot Maven Freemarker Java">
  <link rel="preload" href="https://pldq.gitee.io/assets/css/0.styles.b1164d51.css" as="style"><link rel="preload" href="https://pldq.gitee.io/assets/js/app.2411ec71.js" as="script"><link rel="preload" href="https://pldq.gitee.io/assets/js/3.851c330d.js" as="script"><link rel="preload" href="https://pldq.gitee.io/assets/js/7.b83aea1c.js" as="script"><link rel="preload" href="https://pldq.gitee.io/assets/js/4.75e08570.js" as="script"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/10.bef563c9.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/11.743d948a.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/12.f4c3dc72.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/13.91441604.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/14.f40b6248.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/15.623ac902.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/16.5715ddd1.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/17.224f8cf6.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/5.7cb4259c.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/6.b74c953f.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/8.1082e4f1.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/9.d502b2d0.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/vendors~flowchart.e276d141.js">
  <link rel="stylesheet" href="https://pldq.gitee.io/assets/css/0.styles.b1164d51.css">
</head>
<body>
<div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/default-avatar.png" alt="AngryQi" class="logo"> <span class="site-name can-hide">AngryQi</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/troubleshooting/index.html" class="nav-link">
  问题处理
</a></div><div class="nav-item"><a href="/knowledgeUniverse/index.html" class="nav-link">
  知识宇宙
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/troubleshooting/index.html" class="nav-link">
  问题处理
</a></div><div class="nav-item"><a href="/knowledgeUniverse/index.html" class="nav-link">
  知识宇宙
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Maven依赖位置引发的惨案</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#版本号" class="sidebar-link">版本号</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#问题" class="sidebar-link">问题</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#问题排查" class="sidebar-link">问题排查</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#_1-检查依赖" class="sidebar-link">1. 检查依赖</a></li><li class="sidebar-sub-header"><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#_2-缺少配置" class="sidebar-link">2. 缺少配置</a></li></ul></li><li><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#深入源码" class="sidebar-link">深入源码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#_1-定位异常位置" class="sidebar-link">1. 定位异常位置</a></li><li class="sidebar-sub-header"><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#_2-追踪-internalresourceview" class="sidebar-link">2. 追踪 InternalResourceView</a></li><li class="sidebar-sub-header"><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#_3-深入-freemarker" class="sidebar-link">3. 深入 FreeMarker</a></li><li class="sidebar-sub-header"><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#_4-乱码迷云" class="sidebar-link">4. 乱码迷云</a></li></ul></li><li><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#解决方法" class="sidebar-link">解决方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#_1-修改配置文件编码" class="sidebar-link">1. 修改配置文件编码</a></li><li class="sidebar-sub-header"><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#_2-重写-origintrackedpropertiesloader" class="sidebar-link">2. 重写 OriginTrackedPropertiesLoader</a></li></ul></li><li><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#附带-bug" class="sidebar-link">附带 Bug</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#common-关键介绍" class="sidebar-link">common 关键介绍</a></li><li class="sidebar-sub-header"><a href="/troubleshooting/mavendependencylocation/mavenyi-lai-wei-zhi-yin-fa-de-can-an.html#问题解决" class="sidebar-link">问题解决</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="版本号"><a href="#版本号" class="header-anchor">#</a> 版本号</h2> <ul><li>SpringBoot：2.1.5.RELEASE</li> <li>Freemarker：2.3.28</li></ul> <h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <p>使用浏览器查看Web页面时，页面显示以下信息：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Whitelabel Error Page
This application has no explicit mapping for /error, so you are seeing this as a fallback.

Wed Nov 06 20:40:56 CST 2019
There was an unexpected error (type=Internal Server Error, status=500).
Circular view path [xxx]: would dispatch back to the current handler URL [xxx] again. Check your ViewResolver setup! (Hint: This may be the result of an unspecified view, due to default view name generation.)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div> <p>并且服务打印了一条错误日志（截取有效堆栈信息）：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>javax.servlet.ServletException: Circular view path [xxx]: would dispatch back to the current handler URL [xxx] again. Check your ViewResolver setup! (Hint: This may be the result of an unspecified view, due to default view name generation.)
  at org.springframework.web.servlet.view.InternalResourceView.prepareForRendering(InternalResourceView.java:209)
  at org.springframework.web.servlet.view.InternalResourceView.renderMergedOutputModel(InternalResourceView.java:147)
  at org.springframework.web.servlet.view.AbstractView.render(AbstractView.java:316)
  at org.springframework.web.servlet.DispatcherServlet.render(DispatcherServlet.java:1371)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然而将服务打包成 <code>jar</code> 包后，浏览器就能正确的访问服务的页面，没有该报错</p> <h2 id="问题排查"><a href="#问题排查" class="header-anchor">#</a> 问题排查</h2> <p>出现时首先去搜索引擎和 stackoverflow 上查找问题的解决方法，但是网上提供的方法无非就：</p> <h3 id="_1-检查依赖"><a href="#_1-检查依赖" class="header-anchor">#</a> 1. 检查依赖</h3> <p>依赖没有添加或者添加的不是与 SpringBoot 适配的依赖(需要使用 <code>spring-boot-starter-xxx</code>)</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-freemarker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然而查看 pom 文件中发现<strong>依赖没有问题</strong></p> <h3 id="_2-缺少配置"><a href="#_2-缺少配置" class="header-anchor">#</a> 2. 缺少配置</h3> <p>有些的解决方法是 <code>Freemarker</code> 缺少如下配置:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>spring.freemarker.suffix=.html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然而发现 <code>application.properties</code> 中也存在该配置：</p> <p><img alt="application.properties" data-src="https://pldq.gitee.io/assets/img/20191107094730799.dbe91d96.png" loading="lazy" class="lazy"></p> <h2 id="深入源码"><a href="#深入源码" class="header-anchor">#</a> 深入源码</h2> <p>网上的解决方法并没有解决我的问题，我只能从源码入手排查问题</p> <h3 id="_1-定位异常位置"><a href="#_1-定位异常位置" class="header-anchor">#</a> 1. 定位异常位置</h3> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">prepareForRendering</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>path <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;'url' not set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>preventDispatchLoop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> uri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span> uri<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">:</span> uri<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">applyRelativePath</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span><span class="token string">&quot;Circular view path [&quot;</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">&quot;]: would dispatch back &quot;</span> <span class="token operator">+</span>
          <span class="token string">&quot;to the current handler URL [&quot;</span> <span class="token operator">+</span> uri <span class="token operator">+</span> <span class="token string">&quot;] again. Check your ViewResolver setup! &quot;</span> <span class="token operator">+</span>
          <span class="token string">&quot;(Hint: This may be the result of an unspecified view, due to default view name generation.)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> path<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></details> <p>按照 21 行代码来看，确实是需要将视图名字与请求 <code>uri</code> 设置不同才可以，但是如果这样打出来的 <code>jar</code> 包也应该报出同样的异常</p> <p>显然根本原因不是名称一致的问题导致的，并且这个方法是在 <code>org.springframework.web.servlet.view.InternalResourceView</code> 类中的方法，这个类应该是用来解析 <em>jsp</em> 文件的吧，查看 <em>InternalResourceView</em> 的继承关系如下：</p> <p><img alt="InternalResourceView" data-src="https://pldq.gitee.io/assets/img/20191107103936326.8c49fd8f.png" loading="lazy" class="lazy"></p> <p>并不能看出来什么，但是将同样继承了 <em>AbstractUrlBasedView</em> 的类加入进来后：</p> <p><img alt="AbstractUrlBasedView" data-src="https://pldq.gitee.io/assets/img/20191107104142441.7eb5b2db.png" loading="lazy" class="lazy"></p> <p>资源解析并没有使用 <em>Freemarker</em> 提供的，或者 <em>Freemarker</em> 提供的视图解析不能解析成功</p> <h3 id="_2-追踪-internalresourceview"><a href="#_2-追踪-internalresourceview" class="header-anchor">#</a> 2. 追踪 <em>InternalResourceView</em></h3> <p><em>InternalResourceView</em> 对象是函数调用传进来的，根据堆栈定位到 <code>org.springframework.web.servlet.DispatcherServlet.render(DispatcherServlet.java:1371)</code>，代码如下：</p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token class-name">ModelAndView</span> mv<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// Determine locale for request and apply it to the response.</span>
    <span class="token class-name">Locale</span> locale <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>localeResolver <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>localeResolver<span class="token punctuation">.</span><span class="token function">resolveLocale</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token operator">:</span> request<span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">setLocale</span><span class="token punctuation">(</span>locale<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">View</span> view<span class="token punctuation">;</span>
    <span class="token class-name">String</span> viewName <span class="token operator">=</span> mv<span class="token punctuation">.</span><span class="token function">getViewName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>viewName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// We need to resolve the view name.</span>
      view <span class="token operator">=</span> <span class="token function">resolveViewName</span><span class="token punctuation">(</span>viewName<span class="token punctuation">,</span> mv<span class="token punctuation">.</span><span class="token function">getModelInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> locale<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not resolve view with name '&quot;</span> <span class="token operator">+</span> mv<span class="token punctuation">.</span><span class="token function">getViewName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
<span class="token string">&quot;' in servlet with name '&quot;</span> <span class="token operator">+</span> <span class="token function">getServletName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// No need to lookup: the ModelAndView object contains the actual View object.</span>
      view <span class="token operator">=</span> mv<span class="token punctuation">.</span><span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span><span class="token string">&quot;ModelAndView [&quot;</span> <span class="token operator">+</span> mv <span class="token operator">+</span> <span class="token string">&quot;] neither contains a view name nor a &quot;</span> <span class="token operator">+</span>
<span class="token string">&quot;View object in servlet with name '&quot;</span> <span class="token operator">+</span> <span class="token function">getServletName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Delegate to the View object for rendering.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Rendering view [&quot;</span> <span class="token operator">+</span> view <span class="token operator">+</span> <span class="token string">&quot;] &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mv<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>mv<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      view<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>mv<span class="token punctuation">.</span><span class="token function">getModelInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Error rendering view [&quot;</span> <span class="token operator">+</span> view <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div></details> <p>通过 <em>Debug</em> 调试得 <code>resolveViewName(viewName, mv.getModelInternal(), locale, request)</code> 方法是 <em>InternalResourceView</em> 的出处</p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">protected</span> <span class="token class-name">View</span> <span class="token function">resolveViewName</span><span class="token punctuation">(</span><span class="token class-name">String</span> viewName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> model<span class="token punctuation">,</span>
      <span class="token class-name">Locale</span> locale<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>viewResolvers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ViewResolver</span> viewResolver <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>viewResolvers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">View</span> view <span class="token operator">=</span> viewResolver<span class="token punctuation">.</span><span class="token function">resolveViewName</span><span class="token punctuation">(</span>viewName<span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>view <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> view<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></details> <p><img alt="viewResolver" data-src="https://pldq.gitee.io/assets/img/20191107110940929.9abb3910.png" loading="lazy" class="lazy"></p> <p>其中 <code>ContentNegotiatingViewResolver</code> 类就是负责通过文件名或 <em>header</em> 里面的 <code>Accept</code>属性解析视图（<strong>Implementation of {@link ViewResolver} that resolves a view based on the request file name or {@code Accept} header.</strong>）那么问题就应该出在该类的 <em>resolveViewName</em> 方法中了</p> <h4 id="view-的挑选"><a href="#view-的挑选" class="header-anchor">#</a> <em>view</em> 的挑选</h4> <p><img alt="resolveViewName" data-src="https://pldq.gitee.io/assets/img/20191107111931260.3749d1d8.png" loading="lazy" class="lazy"></p> <p><em>viewResolver</em> 首先获取了候选的 <em>View</em>，然后在候选的 <em>View</em> 中获取一个最佳的 <em>View</em> 用于视图解析</p> <p><img alt="getCandidateViews" data-src="https://pldq.gitee.io/assets/img/20191107112426306.12147887.png" loading="lazy" class="lazy"></p> <p>步入 <em>getCandidateViews</em> 方法后，结果其实已经出来了，<em>FreeMarkerResolver</em> 不能提供一个供候选的 <em>FreeMarkerView</em></p> <h3 id="_3-深入-freemarker"><a href="#_3-深入-freemarker" class="header-anchor">#</a> 3. 深入 <em>FreeMarker</em></h3> <p>通过上文 <em>FreeMarkerResolver</em> 的 <code>resolveViewName</code> 方法步入下去，直到构建 <em>FreeMarkerView</em> 对象都没有产生问题</p> <p><img alt="loadView" data-src="https://pldq.gitee.io/assets/img/20191107115751707.667aefe1.png" loading="lazy" class="lazy"></p> <p>步入下去发现调用 <em>checkResource</em> 内部产生了问题，返回了 <code>false</code></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">checkResource</span><span class="token punctuation">(</span><span class="token class-name">Locale</span> locale<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>url <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;'url' not set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// Check that we can get the template, even if we might subsequently get it again.</span>
      <span class="token function">getTemplate</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> locale<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Allow for ViewResolver chaining...</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContextException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to parse [&quot;</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContextException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to load [&quot;</span> <span class="token operator">+</span> url <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div></details> <p><em>getTemplate</em> 抛出了 <em>FileNotFoundException</em> 异常，异常内容如下：</p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language- line-numbers-mode"><pre class="language-text"><code>Template not found for name &quot;index.html&quot;.
The name was interpreted by this TemplateLoader: MultiTemplateLoader(
  loader1 = org.springframework.ui.freemarker.SpringTemplateLoader@4730608, 
  loader2 = FileTemplateLoader(
    baseDir=&quot;E:\xxxxx\target\classes\META-INF\resources&quot;, 
    canonicalBasePath=&quot;E:\xxxx\target\classes\META-INF\resources\&quot;
  ), loader3 = ClassTemplateLoader(
    resourceLoaderClass=org.springframework.web.servlet.view.freemarker.FreeMarkerConfigurer, 
    basePackagePath=&quot;&quot; /* relatively to resourceLoaderClass pkg */
  )
).
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></details> <p>根据堆栈信息进入栈顶</p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">TemplateLoader</span> tl <span class="token operator">=</span> <span class="token function">getTemplateLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token class-name">String</span> msg<span class="token punctuation">;</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span>tl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    msg <span class="token operator">=</span> <span class="token string">&quot;Don't know where to load template &quot;</span> <span class="token operator">+</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">jQuote</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
          <span class="token operator">+</span> <span class="token string">&quot; from because the \&quot;template_loader\&quot; FreeMarker &quot;</span>
          <span class="token operator">+</span> <span class="token string">&quot;setting wasn't set (Configuration.setTemplateLoader), so it's null.&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> missingTempNormName <span class="token operator">=</span> maybeTemp<span class="token punctuation">.</span><span class="token function">getMissingTemplateNormalizedName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> missingTempReason <span class="token operator">=</span> maybeTemp<span class="token punctuation">.</span><span class="token function">getMissingTemplateReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">TemplateLookupStrategy</span> templateLookupStrategy <span class="token operator">=</span> <span class="token function">getTemplateLookupStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg <span class="token operator">=</span> <span class="token string">&quot;Template not found for name &quot;</span> <span class="token operator">+</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">jQuote</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
<span class="token operator">+</span> <span class="token punctuation">(</span>missingTempNormName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> name <span class="token operator">!=</span> <span class="token keyword">null</span>
        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">removeInitialSlash</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>missingTempNormName<span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token string">&quot; (normalized: &quot;</span> <span class="token operator">+</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">jQuote</span><span class="token punctuation">(</span>missingTempNormName<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span>
        <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
<span class="token operator">+</span> <span class="token punctuation">(</span>customLookupCondition <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot; and custom lookup condition &quot;</span>
<span class="token operator">+</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">jQuote</span><span class="token punctuation">(</span>customLookupCondition<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
<span class="token operator">+</span> <span class="token string">&quot;.&quot;</span>
<span class="token operator">+</span> <span class="token punctuation">(</span>missingTempReason <span class="token operator">!=</span> <span class="token keyword">null</span>
        <span class="token operator">?</span> <span class="token string">&quot;\nReason given: &quot;</span> <span class="token operator">+</span> <span class="token function">ensureSentenceIsClosed</span><span class="token punctuation">(</span>missingTempReason<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
<span class="token operator">+</span> <span class="token string">&quot;\nThe name was interpreted by this TemplateLoader: &quot;</span>
<span class="token operator">+</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">tryToString</span><span class="token punctuation">(</span>tl<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span>
<span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isKnownNonConfusingLookupStrategy</span><span class="token punctuation">(</span>templateLookupStrategy<span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token string">&quot;\n(Before that, the name was possibly changed by this lookup strategy: &quot;</span>
          <span class="token operator">+</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">tryToString</span><span class="token punctuation">(</span>templateLookupStrategy<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.)&quot;</span>
        <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// Suspected reasons or warning:</span>
<span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">!</span>templateLoaderExplicitlySet
        <span class="token operator">?</span> <span class="token string">&quot;\nWarning: The \&quot;template_loader\&quot; FreeMarker setting &quot;</span>
          <span class="token operator">+</span> <span class="token string">&quot;wasn't set (Configuration.setTemplateLoader), and using the default value &quot;</span>
          <span class="token operator">+</span> <span class="token string">&quot;is most certainly not intended and dangerous, and can be the cause of this error.&quot;</span>
        <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
<span class="token operator">+</span> <span class="token punctuation">(</span>missingTempReason <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token operator">?</span> <span class="token string">&quot;\nWarning: The name contains backslash (\&quot;\\\&quot;) instead of slash (\&quot;/\&quot;); &quot;</span>
<span class="token operator">+</span> <span class="token string">&quot;template names should use slash only.&quot;</span>
        <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">String</span> normName <span class="token operator">=</span> maybeTemp<span class="token punctuation">.</span><span class="token function">getMissingTemplateNormalizedName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TemplateNotFoundException</span><span class="token punctuation">(</span>
        normName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> normName <span class="token operator">:</span> name<span class="token punctuation">,</span>
        customLookupCondition<span class="token punctuation">,</span>
        msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div></details> <p>恢复产生异常现场时，发现：</p> <p><img alt="templateLoaderPath" data-src="https://pldq.gitee.io/assets/img/20191107021620258.8ca51038.png" loading="lazy" class="lazy"></p> <p>居然是乱码😲，我的 <em>application.properties</em> 文件(UTF-8)里面不是乱码啊</p> <p><img alt="application" data-src="https://pldq.gitee.io/assets/img/20191107022049779.10497c78.png" loading="lazy" class="lazy"></p> <h3 id="_4-乱码迷云"><a href="#_4-乱码迷云" class="header-anchor">#</a> 4. 乱码迷云</h3> <p>既然知道了 <code>spring.freemarker.template-loader-path</code> 为乱码导致的异常，那么就从这个属性的 <code>setter</code> 函数开始入手</p> <p><img alt="setTemplateLoaderPath" data-src="https://pldq.gitee.io/assets/img/20191107022346877.75cec0fc.png" loading="lazy" class="lazy"></p> <p>忽视反射调用代码：</p> <p><img alt="reflect" data-src="https://pldq.gitee.io/assets/img/20191107022514713.766524e6.png" loading="lazy" class="lazy"></p> <p><code>value</code> 中已经是乱码的路径了， 根据 <code>value</code> 来源往栈顶分析</p> <p><img alt="value" data-src="https://pldq.gitee.io/assets/img/20191107022717524.38cdb775.png" loading="lazy" class="lazy"></p> <p><code>propertyBinder.bindProperty(propertyName, Bindable.of(type).withSuppliedValue(value).withAnnotations(annotations));</code> <em>propertyBinder</em> 是一个 <em>lambda</em> 表达式，继续分析 <em>propertyBinder</em></p> <p><img alt="bound" data-src="https://pldq.gitee.io/assets/img/20191107022925257.400bd8ae.png" loading="lazy" class="lazy"></p> <p><em>propertyBinder</em> 又源于 <em>bind</em> 函数...</p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token class-name">BeanPropertyBinder</span> propertyBinder <span class="token operator">=</span> <span class="token punctuation">(</span>propertyName<span class="token punctuation">,</span> propertyTarget<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">bind</span><span class="token punctuation">(</span>
        name<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">)</span><span class="token punctuation">,</span> propertyTarget<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowRecursiveBinding <span class="token operator">&amp;&amp;</span> context<span class="token punctuation">.</span><span class="token function">hasBoundBean</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">withBean</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
      <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> boundBeans <span class="token operator">=</span> BEAN_BINDERS<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> target<span class="token punctuation">,</span> context<span class="token punctuation">,</span> propertyBinder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> boundBeans<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></details> <p>进入 <em>bind</em> 函数，由于 <em>bind</em> 函数会被属性绑定的地方调用，所以还是下个条件断点吧，断点条件：<code>name.toString().contains(&quot;template-loader-path&quot;)</code></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationPropertyName</span> name<span class="token punctuation">,</span> <span class="token class-name">Bindable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> target<span class="token punctuation">,</span>
      <span class="token class-name">BindHandler</span> handler<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowRecursiveBinding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span><span class="token function">clearConfigurationProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      target <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> target<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">Object</span> bound <span class="token operator">=</span> <span class="token function">bindObject</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> target<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> context<span class="token punctuation">,</span>
          allowRecursiveBinding<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">handleBindResult</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> target<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> context<span class="token punctuation">,</span> bound<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">handleBindError</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> target<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> context<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></details> <p><em>bound</em> 的结果由 <em>bindObject</em> 方法返回，继续分析发现 <em>findProperty</em> 方法</p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token class-name">ConfigurationProperty</span> <span class="token function">findProperty</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationPropertyName</span> name<span class="token punctuation">,</span>
      <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationPropertySource</span> source <span class="token operator">:</span> context<span class="token punctuation">.</span><span class="token function">getSources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">ConfigurationProperty</span> property <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">getConfigurationProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> property<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></details> <p>这个函数首先从 <em>systemProperties</em> 搜索属性值（肯定没有😀），然后从 <em>systemEnvironment</em> 搜索，然后匹配是否需要产生随机数 <em>RandomValuePropertySource</em>，然后从配置文件里面查找</p> <p><img alt="findProperty" data-src="https://pldq.gitee.io/assets/img/20191107025506313.099bc8cd.png" loading="lazy" class="lazy"></p> <h4 id="配置文件加载"><a href="#配置文件加载" class="header-anchor">#</a> 配置文件加载</h4> <p><img alt="OriginTrackedMapPropertySource" data-src="https://pldq.gitee.io/assets/img/20191107031426550.a0f8c3b1.png" loading="lazy" class="lazy"></p> <p>配置文件里面的信息都加载到了 <em>OriginTrackedMapPropertySource</em> 类中</p> <p><img alt="" data-src="https://pldq.gitee.io/assets/img/20191107031951436.6e5b74c6.png" loading="lazy" class="lazy"></p> <p><em>OriginTrackedValue</em> 中存取着属性，老调重弹，在 <em>of</em> 方法中下断点</p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language- line-numbers-mode"><pre class="language-text"><code>public class OriginTrackedValue implements OriginProvider {
  public static OriginTrackedValue of(Object value, Origin origin) {
    if (value == null) {
      return null;
    }
    if (value instanceof CharSequence) {
      return new OriginTrackedCharSequence((CharSequence) value, origin);
    }
    return new OriginTrackedValue(value, origin);
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></details> <p>按堆栈查找文件读入的位置，终于在 <em>OriginTrackedPropertiesLoader</em> 类中发现：</p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">OriginTrackedValue</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> expandLists<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">CharacterReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CharacterReader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">OriginTrackedValue</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">StringBuilder</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token function">loadKey</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> reader<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expandLists <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;[]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          key <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">do</span> <span class="token punctuation">{</span>
<span class="token class-name">OriginTrackedValue</span> value <span class="token operator">=</span> <span class="token function">loadValue</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> reader<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">put</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> key <span class="token operator">+</span> <span class="token string">&quot;[&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reader<span class="token punctuation">.</span><span class="token function">isEndOfLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>reader<span class="token punctuation">.</span><span class="token function">isEndOfLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token class-name">OriginTrackedValue</span> value <span class="token operator">=</span> <span class="token function">loadValue</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> reader<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">put</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div></details> <p>进入 <em>CharacterReader</em> 类，恍然大悟，原来默认是按照 <em>ISO_8859_1</em> 编码进行文件读入（难怪乱码，难怪找不到😭😭）</p> <p><img alt="ISO_8859_1" data-src="https://pldq.gitee.io/assets/img/20191107032719361.29857952.png" loading="lazy" class="lazy"></p> <h2 id="解决方法"><a href="#解决方法" class="header-anchor">#</a> 解决方法</h2> <h3 id="_1-修改配置文件编码"><a href="#_1-修改配置文件编码" class="header-anchor">#</a> 1. 修改配置文件编码</h3> <p>将配置文件编码修改为 <em>ISO_8859_1</em> 编码，或者不使用中文，及其不友好</p> <h3 id="_2-重写-origintrackedpropertiesloader"><a href="#_2-重写-origintrackedpropertiesloader" class="header-anchor">#</a> 2. 重写 <em>OriginTrackedPropertiesLoader</em></h3> <p>在项目下建立 <em>org.springframework.boot.env</em> 包，必须严格一致，然后在包内放入以下类:</p> <h4 id="propertiespropertysourceloader"><a href="#propertiespropertysourceloader" class="header-anchor">#</a> PropertiesPropertySourceLoader</h4> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/*
 * Copyright 2012-2018 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>env</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>env<span class="token punctuation">.</span></span><span class="token class-name">PropertySource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Resource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">EncodedResource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">PropertiesLoaderUtils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Strategy to load '.properties' files into a {@link PropertySource}.
 * @author Dave Syer
 * @author Phillip Webb
 * @author Madhura Bhave
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PropertiesPropertySourceLoader</span> <span class="token keyword">implements</span> <span class="token class-name">PropertySourceLoader</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> XML_FILE_EXTENSION <span class="token operator">=</span> <span class="token string">&quot;.xml&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getFileExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;properties&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;xml&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertySource</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span>
<span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> properties <span class="token operator">=</span> <span class="token function">loadProperties</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Collections</span>
    <span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OriginTrackedMapPropertySource</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadProperties</span><span class="token punctuation">(</span><span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> filename <span class="token operator">=</span> resource<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//支持读入utf8编码的配置文件</span>
        <span class="token class-name">EncodedResource</span> encodedResource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EncodedResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>filename <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> filename<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>XML_FILE_EXTENSION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token class-name">PropertiesLoaderUtils</span><span class="token punctuation">.</span><span class="token function">loadProperties</span><span class="token punctuation">(</span>encodedResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OriginTrackedPropertiesLoaderUTF8</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div></details> <h4 id="origintrackedpropertiesloaderutf8"><a href="#origintrackedpropertiesloaderutf8" class="header-anchor">#</a> OriginTrackedPropertiesLoaderUTF8</h4> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/*
 * Copyright 2012-2018 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>env</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>origin<span class="token punctuation">.</span></span><span class="token class-name">Origin</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>origin<span class="token punctuation">.</span></span><span class="token class-name">OriginTrackedValue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>origin<span class="token punctuation">.</span></span><span class="token class-name">TextResourceOrigin</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>origin<span class="token punctuation">.</span></span><span class="token class-name">TextResourceOrigin<span class="token punctuation">.</span>Location</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Resource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Assert</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Closeable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStreamReader</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">LineNumberReader</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">LinkedHashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Class to load {@code .properties} files into a map of {@code String} -&gt;
 * {@link OriginTrackedValue}. Also supports expansion of {@code name[]=a,b,c} list style
 * values.
 *
 * @author Madhura Bhave
 * @author Phillip Webb
 * @author Thiago Hirata
 */</span>
<span class="token keyword">class</span> <span class="token class-name">OriginTrackedPropertiesLoaderUTF8</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Create a new {@link OriginTrackedPropertiesLoaderUTF8} instance.
   * @param resource the resource of the {@code .properties} data
   */</span>
  <span class="token class-name">OriginTrackedPropertiesLoaderUTF8</span><span class="token punctuation">(</span><span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> <span class="token string">&quot;Resource must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resource <span class="token operator">=</span> resource<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Load {@code .properties} data and return a map of {@code String} -&gt;
   * {@link OriginTrackedValue}.
   * @return the loaded properties
   * @throws IOException on read error
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">OriginTrackedValue</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Load {@code .properties} data and return a map of {@code String} -&gt;
   * {@link OriginTrackedValue}.
   * @param expandLists if list {@code name[]=a,b,c} shortcuts should be expanded
   * @return the loaded properties
   * @throws IOException on read error
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">OriginTrackedValue</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> expandLists<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">CharacterReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CharacterReader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">OriginTrackedValue</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">StringBuilder</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token function">loadKey</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> reader<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expandLists <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;[]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          key <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">do</span> <span class="token punctuation">{</span>
<span class="token class-name">OriginTrackedValue</span> value <span class="token operator">=</span> <span class="token function">loadValue</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> reader<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">put</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> key <span class="token operator">+</span> <span class="token string">&quot;[&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reader<span class="token punctuation">.</span><span class="token function">isEndOfLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>reader<span class="token punctuation">.</span><span class="token function">isEndOfLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token class-name">OriginTrackedValue</span> value <span class="token operator">=</span> <span class="token function">loadValue</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> reader<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">put</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">OriginTrackedValue</span><span class="token punctuation">&gt;</span></span> result<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span>
      <span class="token class-name">OriginTrackedValue</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">loadKey</span><span class="token punctuation">(</span><span class="token class-name">StringBuilder</span> buffer<span class="token punctuation">,</span> <span class="token class-name">CharacterReader</span> reader<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    buffer<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> previousWhitespace <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>reader<span class="token punctuation">.</span><span class="token function">isEndOfLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">isPropertyDelimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reader<span class="token punctuation">.</span><span class="token function">isWhiteSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> previousWhitespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      previousWhitespace <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">isWhiteSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      buffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">getCharacter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">OriginTrackedValue</span> <span class="token function">loadValue</span><span class="token punctuation">(</span><span class="token class-name">StringBuilder</span> buffer<span class="token punctuation">,</span> <span class="token class-name">CharacterReader</span> reader<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> splitLists<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    buffer<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">isWhiteSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>reader<span class="token punctuation">.</span><span class="token function">isEndOfLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Location</span> location <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>reader<span class="token punctuation">.</span><span class="token function">isEndOfLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>splitLists <span class="token operator">&amp;&amp;</span> reader<span class="token punctuation">.</span><span class="token function">isListDelimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      buffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">getCharacter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Origin</span> origin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextResourceOrigin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resource<span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">OriginTrackedValue</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Reads characters from the source resource, taking care of skipping comments,
   * handling multi-line values and tracking {@code '\'} escapes.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CharacterReader</span> <span class="token keyword">implements</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ESCAPES <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;trnf&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\t\r\n\f&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LineNumberReader</span> reader<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> columnNumber <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> escaped<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> character<span class="token punctuation">;</span>

    <span class="token class-name">CharacterReader</span><span class="token punctuation">(</span><span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LineNumberReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>
          resource<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> wrappedLine<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>escaped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>columnNumber<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>columnNumber <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">skipLeadingWhitespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wrappedLine<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">skipComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token string">'\\'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>escaped <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">readEscaped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>columnNumber <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">isEndOfFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">skipLeadingWhitespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isWhiteSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>columnNumber<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">skipComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token string">'#'</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token string">'!'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">!=</span> <span class="token string">'\n'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>columnNumber <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readEscaped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> escapeIndex <span class="token operator">=</span> ESCAPES<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>character<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>escapeIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">=</span> ESCAPES<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>escapeIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>columnNumber <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">read</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token string">'u'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">readUnicode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readUnicode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> digit <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>digit <span class="token operator">&gt;=</span> <span class="token string">'0'</span> <span class="token operator">&amp;&amp;</span> digit <span class="token operator">&lt;=</span> <span class="token string">'9'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> digit <span class="token operator">-</span> <span class="token string">'0'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>digit <span class="token operator">&gt;=</span> <span class="token string">'a'</span> <span class="token operator">&amp;&amp;</span> digit <span class="token operator">&lt;=</span> <span class="token string">'f'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> digit <span class="token operator">-</span> <span class="token string">'a'</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>digit <span class="token operator">&gt;=</span> <span class="token string">'A'</span> <span class="token operator">&amp;&amp;</span> digit <span class="token operator">&lt;=</span> <span class="token string">'F'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> digit <span class="token operator">-</span> <span class="token string">'A'</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Malformed \\uxxxx encoding.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isWhiteSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>escaped <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token string">' '</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token string">'\t'</span>
          <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token string">'\f'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEndOfFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEndOfLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>escaped <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isListDelimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>escaped <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token string">','</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isPropertyDelimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>escaped <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token string">'='</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>character <span class="token operator">==</span> <span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">char</span> <span class="token function">getCharacter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>character<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Location</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Location</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">getLineNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>columnNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br></div></div></details> <h2 id="附带-bug"><a href="#附带-bug" class="header-anchor">#</a> 附带 <em>Bug</em></h2> <p>当准备用方法二来解决这个问题时，发现项目的 <code>common</code> 包里包含了这个文件，但是并没有使用 <em>OriginTrackedPropertiesLoaderUTF8</em> 这个类来加载配置文件</p> <h3 id="common-关键介绍"><a href="#common-关键介绍" class="header-anchor">#</a> <em>common</em> 关键介绍</h3> <p>项目的 <em>common</em> 模块最终会被 <em>Maven</em> 打包成 <em>jar</em> 包被其他模块依赖</p> <p>在程序运行时，一直使用的是默认的 <em>PropertiesPropertySourceLoader</em> 类，而没有使用 <em>common</em> 模块里面的 <em>PropertiesPropertySourceLoader</em>，也就是说<strong>类加载器先加载的是 SpringBoot 依赖中的类</strong></p> <h3 id="问题解决"><a href="#问题解决" class="header-anchor">#</a> 问题解决</h3> <p>将 <em>common</em> 模块的依赖放到最上部...</p> <p><img alt="fix" data-src="https://pldq.gitee.io/assets/img/20191107034503162.a9ce8d96.png" loading="lazy" class="lazy"></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新日期:</span> <span class="time">2021-1-21 20:38:29</span></div></footer> <!---->  <div class="comments-container"></div></main></div><div class="global-ui"><!----><!----></div></div>
<script src="https://pldq.gitee.io/assets/js/app.2411ec71.js" defer></script><script src="https://pldq.gitee.io/assets/js/3.851c330d.js" defer></script><script src="https://pldq.gitee.io/assets/js/7.b83aea1c.js" defer></script><script src="https://pldq.gitee.io/assets/js/4.75e08570.js" defer></script>
</body>
</html>
