<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>tomcat未知阻塞之谜 | AngryQi</title>
  
  <meta name="description" content="# 版本号 SpringBoot: 2.1.10.RELEASE Tomcat-Embed: 9.0.27 # 问题现象 使用 Chrome 浏览器浏览页面时，每个页面加载时间非常长，通过浏览器开发者工具可以看到页面每个接口的调用时间都在 10s 左右（包括静态资源和API接口） ">
    <meta name="keywords" content="SpringBoot Tomcat Java getnameinfo">
  <link rel="preload" href="https://pldq.gitee.io/assets/css/0.styles.b1164d51.css" as="style"><link rel="preload" href="https://pldq.gitee.io/assets/js/app.2411ec71.js" as="script"><link rel="preload" href="https://pldq.gitee.io/assets/js/3.851c330d.js" as="script"><link rel="preload" href="https://pldq.gitee.io/assets/js/7.b83aea1c.js" as="script"><link rel="preload" href="https://pldq.gitee.io/assets/js/6.b74c953f.js" as="script"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/10.bef563c9.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/11.743d948a.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/12.f4c3dc72.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/13.91441604.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/14.f40b6248.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/15.623ac902.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/16.5715ddd1.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/17.224f8cf6.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/4.75e08570.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/5.7cb4259c.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/8.1082e4f1.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/9.d502b2d0.js"><link rel="prefetch" href="https://pldq.gitee.io/assets/js/vendors~flowchart.e276d141.js">
  <link rel="stylesheet" href="https://pldq.gitee.io/assets/css/0.styles.b1164d51.css">
</head>
<body>
<div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/default-avatar.png" alt="AngryQi" class="logo"> <span class="site-name can-hide">AngryQi</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/troubleshooting/index.html" class="nav-link">
  问题处理
</a></div><div class="nav-item"><a href="/knowledgeUniverse/index.html" class="nav-link">
  知识宇宙
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/troubleshooting/index.html" class="nav-link">
  问题处理
</a></div><div class="nav-item"><a href="/knowledgeUniverse/index.html" class="nav-link">
  知识宇宙
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>tomcat未知阻塞之谜</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/troubleshooting/tomcatblockingproblem/tomcatwei-zhi-zu-sai-zhi-mi.html#版本号" class="sidebar-link">版本号</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/troubleshooting/tomcatblockingproblem/tomcatwei-zhi-zu-sai-zhi-mi.html#问题现象" class="sidebar-link">问题现象</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/troubleshooting/tomcatblockingproblem/tomcatwei-zhi-zu-sai-zhi-mi.html#排查过程" class="sidebar-link">排查过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/troubleshooting/tomcatblockingproblem/tomcatwei-zhi-zu-sai-zhi-mi.html#_1-过滤器-拦截器" class="sidebar-link">1. 过滤器？拦截器？</a></li><li class="sidebar-sub-header"><a href="/troubleshooting/tomcatblockingproblem/tomcatwei-zhi-zu-sai-zhi-mi.html#_2-定位阻塞位置" class="sidebar-link">2. 定位阻塞位置</a></li><li class="sidebar-sub-header"><a href="/troubleshooting/tomcatblockingproblem/tomcatwei-zhi-zu-sai-zhi-mi.html#_3-定位-openjdk-源码" class="sidebar-link">3. 定位 OpenJdk 源码</a></li><li class="sidebar-sub-header"><a href="/troubleshooting/tomcatblockingproblem/tomcatwei-zhi-zu-sai-zhi-mi.html#确定罪魁祸首" class="sidebar-link">确定罪魁祸首</a></li><li class="sidebar-sub-header"><a href="/troubleshooting/tomcatblockingproblem/tomcatwei-zhi-zu-sai-zhi-mi.html#深究原因" class="sidebar-link">深究原因</a></li></ul></li><li><a href="/troubleshooting/tomcatblockingproblem/tomcatwei-zhi-zu-sai-zhi-mi.html#解决方法" class="sidebar-link">解决方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/troubleshooting/tomcatblockingproblem/tomcatwei-zhi-zu-sai-zhi-mi.html#更换容器" class="sidebar-link">更换容器</a></li><li class="sidebar-sub-header"><a href="/troubleshooting/tomcatblockingproblem/tomcatwei-zhi-zu-sai-zhi-mi.html#使用-hosts" class="sidebar-link">使用 hosts</a></li><li class="sidebar-sub-header"><a href="/troubleshooting/tomcatblockingproblem/tomcatwei-zhi-zu-sai-zhi-mi.html#干掉系统-dns" class="sidebar-link">干掉系统 DNS</a></li></ul></li><li><a href="/troubleshooting/tomcatblockingproblem/tomcatwei-zhi-zu-sai-zhi-mi.html#参考文献" class="sidebar-link">参考文献</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="版本号"><a href="#版本号" class="header-anchor">#</a> 版本号</h2> <ul><li>SpringBoot: 2.1.10.RELEASE</li> <li>Tomcat-Embed: 9.0.27</li></ul> <h2 id="问题现象"><a href="#问题现象" class="header-anchor">#</a> 问题现象</h2> <p>使用 Chrome 浏览器浏览页面时，每个页面加载时间非常长，通过浏览器开发者工具可以看到页面每个接口的调用时间都在 10s 左右（<strong>包括静态资源和API接口</strong>）</p> <p><img alt="接口调用明细" data-src="https://pldq.gitee.io/assets/img/20200903193711.645ba9b0.png" loading="lazy" class="lazy"></p> <h2 id="排查过程"><a href="#排查过程" class="header-anchor">#</a> 排查过程</h2> <h3 id="_1-过滤器-拦截器"><a href="#_1-过滤器-拦截器" class="header-anchor">#</a> 1. 过滤器？拦截器？</h3> <p>由于接口调用时间大都一致，脑海中首先推断可能是代码中存在的单点验证等过滤器或拦截器造成的，如果其中逻辑存在阻塞就有可能出现该情况，并且接口调用时间就约等于阻塞时间</p> <p>为了验证这个猜想，使用命令开启服务器端远程调试，附加到该服务进行调试，分别在执行过滤器代码前和 controller 的第一行下断点</p> <p>远程调试参数如下：</p> <div class="language-shell script line-numbers-mode"><pre class="language-shell"><code>-agentlib:jdwp<span class="token operator">=</span>transport<span class="token operator">=</span>dt_socket,server<span class="token operator">=</span>y,suspend<span class="token operator">=</span>n,address<span class="token operator">=</span><span class="token number">20080</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下断点后重新调用接口，然后发现程序在两个端点之间执行的速度几乎可以忽略不计，由此可见并不是过滤器或者拦截器的问题，但是也说明了<strong>阻塞位置位于过滤器逻辑执行之前</strong></p> <p><img alt="" data-src="https://pldq.gitee.io/assets/img/1599133749.11c58a41.jpg" loading="lazy" class="lazy"></p> <h3 id="_2-定位阻塞位置"><a href="#_2-定位阻塞位置" class="header-anchor">#</a> 2. 定位阻塞位置</h3> <p>不断下断点尝试后，终于定位出代码阻塞位置，位于 <code>RemoteIpValve</code> 类中的 610 行</p> <div class="language-java line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>valves</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RemoteIpValve</span> <span class="token keyword">extends</span> <span class="token class-name">ValveBase</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">,</span> <span class="token class-name">Response</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> originalRemoteAddr <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> originalRemoteHost <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRemoteHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> originalScheme <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> originalSecure <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">isSecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> originalServerName <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getServerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> originalLocalName <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getLocalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> originalServerPort <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getServerPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> originalLocalPort <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getLocalPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>步入 <code>request.getLocalName()</code> 方法，最终到达 <code>InetAddress</code> 类中的 <code>getHostFromNameService</code> 静态方法，它能够获取给定IP地址的主机名</p> <div class="language-java line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">java<span class="token punctuation">.</span>net</span><span class="token punctuation">;</span>

<span class="token keyword">public</span>
<span class="token keyword">class</span> <span class="token class-name">InetAddress</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getHostFromNameService</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span> addr<span class="token punctuation">,</span> <span class="token keyword">boolean</span> check<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> host <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// first lookup the hostname</span>
                host <span class="token operator">=</span> nameService<span class="token punctuation">.</span><span class="token function">getHostByAddr</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">/* check to see if calling code is allowed to know
                 * the hostname for this IP address, ie, connect to the host
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>check<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SecurityManager</span> sec <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>sec <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        sec<span class="token punctuation">.</span><span class="token function">checkConnect</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
		<span class="token comment">// ...省略</span>
        <span class="token keyword">return</span> host<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>满怀着要柳暗花明的心情继续步入，却发现没那么简单...</p> <div class="language-java line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">java<span class="token punctuation">.</span>net</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Inet4AddressImpl</span> <span class="token keyword">implements</span> <span class="token class-name">InetAddressImpl</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token class-name">String</span> <span class="token function">getLocalHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token class-name">InetAddress</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token function">lookupAllHostAddr</span><span class="token punctuation">(</span><span class="token class-name">String</span> hostname<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token class-name">String</span> <span class="token function">getHostByAddr</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> addr<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">boolean</span> <span class="token function">isReachable0</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> addr<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ifaddr<span class="token punctuation">,</span> <span class="token keyword">int</span> ttl<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>靠，<code>getHostByAddr</code> 是一个 native 方法</p> <p><img alt="" data-src="https://pldq.gitee.io/assets/img/1599135971.d412f6f8.jpg" loading="lazy" class="lazy"></p> <h3 id="_3-定位-openjdk-源码"><a href="#_3-定位-openjdk-源码" class="header-anchor">#</a> 3. 定位 OpenJdk 源码</h3> <p>前往 OpenJdk 官网下载 jdk1.8 的源码（本文暂不详细描述）</p> <p>根据JNI官方文档可以得知，本地方法命名按照以下部分拼接得成：</p> <ul><li><code>Java_</code> 前缀</li> <li>转义过的全限定类名（包名+类名）</li> <li><code>_</code>下划线分隔符</li> <li>转义过的方法名</li> <li>对于重载的本地方法，使用 <code>__</code> 在转义过的参数签名前</li></ul> <p>根据此规则，可以得知 <code>getHostByAddr</code> 对应的本地方法名为 <code>Java_java_net_Inet4AddressImpl_getHostByAddr</code></p> <p>搜索方法名结果如下，有三个地方定义了该方法，由于测试环境是 Centos 操作系统，所以 windows 上的实现可以不看了</p> <p><img alt="" data-src="https://pldq.gitee.io/assets/img/20200904105913.b06f6e1c.png" loading="lazy" class="lazy"></p> <p>定位到 <code>jdk\src\solaris\native\java\net\Inet4AddressImpl.c</code> 文件， 该文件中实现了两个 <code>Java_java_net_Inet4AddressImpl_getHostByAddr</code> 方法，两个实现由 <code>_ALLBSD_SOURCE</code> 和 <code>HAS_GLIBC_GETHOSTBY_R</code> 宏定义控制</p> <p><img alt="" data-src="https://pldq.gitee.io/assets/img/1599188666.82c4399b.jpg" loading="lazy" class="lazy"></p> <p>centos操作系统最终调用的方法如下：</p> <div class="language-c line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-c"><code>JNIEXPORT jstring JNICALL
<span class="token function">Java_java_net_Inet4AddressImpl_getHostByAddr</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject this<span class="token punctuation">,</span>
                                            jbyteArray addrArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jstring ret <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> host<span class="token punctuation">[</span>NI_MAXHOST<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    jbyte caddr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> him4<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>sa<span class="token punctuation">;</span>

    jint addr<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetByteArrayRegion</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> addrArray<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> caddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>caddr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addr <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>caddr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff0000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addr <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>caddr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    addr <span class="token operator">|=</span> <span class="token punctuation">(</span>caddr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>him4<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>him4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    him4<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span> <span class="token function">htonl</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    him4<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    sa <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>him4<span class="token punctuation">;</span>
    len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>him4<span class="token punctuation">)</span><span class="token punctuation">;</span>

    error <span class="token operator">=</span> <span class="token function">getnameinfo</span><span class="token punctuation">(</span>sa<span class="token punctuation">,</span> len<span class="token punctuation">,</span> host<span class="token punctuation">,</span> NI_MAXHOST<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                        NI_NAMEREQD<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">JNU_ThrowByName</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> JNU_JAVANETPKG <span class="token string">&quot;UnknownHostException&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>正道的光照在了 <code>getnameinfo</code> 方法上</p> <h3 id="确定罪魁祸首"><a href="#确定罪魁祸首" class="header-anchor">#</a> 确定罪魁祸首</h3> <p>为了确定这个猜想，特意用c语言写了一个小程序，程序源码如下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;sys/timeb.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;netdb.h&quot;</span></span>

using namespace std<span class="token punctuation">;</span>

<span class="token keyword">long</span> <span class="token function">getCurrentMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    timeb time<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">ftime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> time<span class="token punctuation">.</span>time <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">+</span> time<span class="token punctuation">.</span>millitm<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token function">getCurrentMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> addr<span class="token punctuation">;</span> <span class="token comment">// 此处定义要查询的ip地址</span>
    sockaddr_in him4<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    sockaddr <span class="token operator">*</span>sa<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>him4<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>him4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    him4<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span> <span class="token function">htonl</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    him4<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    sa <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span>sockaddr <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>him4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>him4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> host<span class="token punctuation">[</span>NI_MAXHOST <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">getnameinfo</span><span class="token punctuation">(</span>sa<span class="token punctuation">,</span> len<span class="token punctuation">,</span> host<span class="token punctuation">,</span> NI_MAXHOST<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> NI_NAMEREQD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token function">getCurrentMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;getnameinfo = &quot;</span><span class="token operator">&lt;&lt;</span> host <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;getnameinfo cost time &quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; ms&quot;</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>将程序编译后放到测试环境上运行，程序运行结果如下</p> <p><img alt="" data-src="https://pldq.gitee.io/assets/img/20200904142421.099ecca2.png" loading="lazy" class="lazy"></p> <p>果然是 <code>getnameinfo</code> 方法，这个方法调用一次就需要 10s</p> <h3 id="深究原因"><a href="#深究原因" class="header-anchor">#</a> 深究原因</h3> <p>搜索一圈 <code>getnameinfo</code> 后，发现这个函数是通过向 DNS 反向查询主机名，如果 dns 反向查找找不到主机名就阻塞住</p> <p>更多信息查看 <a href="https://social.msdn.microsoft.com/Forums/windowsapps/en-US/5e8ce3a5-8c96-4205-a8ec-ba9a708b8c16/getnameinfo-very-slow?forum=windowsgeneraldevelopmentissues" target="_blank" rel="noopener noreferrer">getnameinfo very slow!<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="解决方法"><a href="#解决方法" class="header-anchor">#</a> 解决方法</h2> <h3 id="更换容器"><a href="#更换容器" class="header-anchor">#</a> 更换容器</h3> <p>当使用 <code>undertow</code> 替换 <code>tomcat</code> 时，该问题不会复现（目前使用方法），替换容器只需要在 pom 文件中引用依赖和排除掉tomcat依赖即可</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-tomcat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-undertow<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="使用-hosts"><a href="#使用-hosts" class="header-anchor">#</a> 使用 hosts</h3> <p>操作系统规定，在进行DNS请求以前，先检查系自己的Hosts文件中是否有这个域名和IP的映射关系。如果有，则直接访问这个IP地址指定的网络位置，如果没有，再向已知的DNS服务器提出域名解析请求。也就是说Hosts的IP解析优先级比DNS要高。</p> <p>修改 <code>/etc/hosts</code> 文件，将解析结果直接写死在该文件中</p> <p><img alt="" data-src="https://pldq.gitee.io/assets/img/20200904141300.4728d9ea.png" loading="lazy" class="lazy"></p> <p>运行程序测试结果如下：</p> <p><img alt="" data-src="data:image/png;base64,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" loading="lazy" class="lazy"></p> <h3 id="干掉系统-dns"><a href="#干掉系统-dns" class="header-anchor">#</a> 干掉系统 DNS</h3> <p>既然大部分时间阻塞在DNS反向查询上，那么干掉DNS应该解决问题了</p> <p>编辑 <code>/etc/resolv.conf</code> 文件，将文件内容备份并清空，再次运行程序查看</p> <p><img alt="" data-src="https://pldq.gitee.io/assets/img/20200904135405.af478621.png" loading="lazy" class="lazy"></p> <p>每次查询只需要 1ms，这也证实了这个函数内部确实走了 dns</p> <h2 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h2> <ul><li>[1] <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/jni/spec/design.html" target="_blank" rel="noopener noreferrer">JNI Chapter 2: Design Overview<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新日期:</span> <span class="time">2021-1-31 3:11:13</span></div></footer> <!---->  <div class="comments-container"></div></main></div><div class="global-ui"><!----><!----></div></div>
<script src="https://pldq.gitee.io/assets/js/app.2411ec71.js" defer></script><script src="https://pldq.gitee.io/assets/js/3.851c330d.js" defer></script><script src="https://pldq.gitee.io/assets/js/7.b83aea1c.js" defer></script><script src="https://pldq.gitee.io/assets/js/6.b74c953f.js" defer></script>
</body>
</html>
